## 拜占庭将军问题：最复杂的分布式容错模型

二忠一叛难题 --- 有人在作恶

口信消息型拜占庭问题之解 --- n位将军，最多能容忍（n - 1）/ 3位叛将

签名消息型拜占庭问题之解 --- 通过签名防止信息篡改，来解决问题

拜占庭容错和非拜占庭容错 

- 拜占庭容错算法：PBFT，PoW
- 故障容错算法（非拜占庭容错算法）：Paxos,Raft,ZAB,Quorum NWR, 2PC,TCC

## 拜占庭容错算法

有人作恶，好人要能达到共识

POW算法：通过一定的工作量证明你是好人

PBFT：通过签名消息约束叛变行为

## CAP理论：酸碱平衡之道

### CAP理论

分布式系统的PH试纸

CAP三指标

- C：数据正确
- A：服务可用
- P：分区容错

CAP不可能三角 --- CAP定理

如何使用CAP理论 --- 实际系统剖析

### ACID理论

本质

- ACID是对事物特性的抽象和总结
- 实现了操作的ACID，就实现了事务

分布式事务

- 两阶段提交协议
  - 二阶段提交协商
  - 提交请求阶段
  - 提交执行阶段

- TCC
  - Try(预留)
  - Confirm(确认)
  - Cancel(撤销)

### BASE理论

基本可用

- 流量削峰
- 延迟响应
- 体验降级

最终一致性

- 哪些场景适合最终一致性
- 到底以什么为准
- 如何实现最终一致性
- 自定义写一致性级别

软状态 --- 过渡状态

如何使用BASE理论 --- 实际系统剖析

## 分布式事务：进退与共

要么全部执行，要么全部不执行，系统状态的一致性

两阶段提交协议

- 提交请求阶段
- 提交执行阶段
- 实现数据层面的分布式事务

TCC（Try-Confirm-Cancel）

- 预留
- 执行/撤销
- 实现业务层面的分布式事务

XA规范

- 事务管理器和资源管理器之间双向通讯的接口规范
- 实现了二阶段提交协议
- 通过MySql XA可以实现多个数据库的操作的分布式事务

## 分布式强一致性：你必须给我最新的数据

强一致性：写操作完成后，任何后续访问都能读到更新后的值

Paxos算法

- Basic Paxos

  - 实现单值的共识
  - 三种角色，提议者（Proposer）、接受者（Acceptor）、学习者（Learner）
  - 二阶段提交
    - 准备（Prepare）阶段
    - 接受（Accept）阶段

  - 缺少一些编程必须细节，出现众多Paxos变种

- Multi-Paxos

  - Multi-Paxos是Paxos变种，通过多个Basic Paxos实例实现一组数据的一致性

  - Multi-Paxos是一个统称，Chubby的Paxos实现，ZAB协议，Raft算法本质上也是Multi-Paxos

  - Chubby的Paxos实现

    - 引入Master，优化协商效率，提升性能
    - 日志复制和一致性
      - 以Master为准
      - 故障恢复后，通过catch-up机制进行数据恢复
      - 成员变更时，新加入节点，先同步状态和数据，不具有投票权

    - Chubby能容错（n - 1）/ 2个节点的故障

Raft算法

- 最常用的一致性算法
- 最不被当做Paxos变种的Paxos变种
- 三种角色，领导者，候选人，跟随者
- 强领导者模型
  - 选举领导者
  - 节点通讯
    - 请求投票（RequestVote）RPC
    - 日志复制（AppendEntries）RPC
  - 任期
    - 任期编号
    - Raft算法中的任期，不只是时间段，而且，任期编号的大小，会影响领导者选举和请求处理
  - 选举规则
    - 领导者的心跳消息，能阻止跟随者发起新的选举
    - 指定时间内，未接收到领导者的信息，跟随者推举自己为候选人，发起选举
    - 赢得大多数选票的候选人，将晋升为领导者
    - 在一次选举中，美一个服务器节点，最多会对一个任期编号，投出一张选票
    - 当任期编号相同时，日志完整性高的跟随者，将拒绝投票给日志完整性低的候选人
  - 随机超时时间
    - 第一种含义是，跟随者，等待领导这心跳信息超时，然后发起选举的随机时间间隔
    - 第二种含义是，当没有候选人赢得过半票数，选举无效时，等待选举超时，然后再发起新一轮选举的时间间隔
  - 日志，一切以“领导者”为准
- 日志的一致性
- 联合共识
- 单节点变更

## 分布式最终一致性：数据旧点没关系

最终一致性：保证如果对某个对象没有新的写操作了，最终所有后续访问都能读到相同的最近最新的值。

Gossip协议三板斧

- 直接邮寄
- 反熵
- 谣言传播

Qurum NWR

- 自定义一致性级别
- 按需支持强一致性

## ZAB协议：ZooKeeper背后的一致性秘密

ZooKeeper是Chubby的开源替代

ZooKeeper基于读性能的考虑，提供的是最终一致性

ZAB协议

- 实现操作的顺序性
- 领导者选举
- 故障恢复

## 实战：实践是最好的学习方式

InfluxDB企业版一致性实现剖析

- META节点一致性实现
  - 强一致性
  - raft

- DATA节点的一致性实现
  - 最终一致性
  - 反熵
  - Quorum NWR

Hashicorp Raft

- 跟着理论理解代码实现
- 以”集群节点“为中心的API用法

基于Raft的分布式KV系统开发实战

- 架构设计
- 代码实现

![img](%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4-%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E8%AE%AE%E4%B8%8E%E7%AE%97%E6%B3%95%E5%AE%9E%E6%88%98.assets/122bdf34957c6277352ea51c43552213.png)