raft是强leader型，所以性能瓶颈都在leader节点，如果leader挂了，写请求已经挂了，读情况视配置情况而定，如果要求强一致性，则读写都在leader节点，则leader挂了，都挂。

raft相关：**领导者选举，日志复制，成员变更**，三个为核心。

基于raft实现的分布式系统有：etcd，tidb，consul，cockroachdb

raft可以得心应手的处理绝大部分场景的容错和一致性需要，比如：分布式配置系统，分布式NoSQL存储等

raft的本质是：通过一切以领导者为准的方式，实现一系列值的共识和各节点日志的一致。

raft节点的三种状态：leader，follower，candidate

leader平时的工作内容有三部分：处理写请求，管理日志复制和不断的发送心跳信息，通知其他节点“我是领导者，我还活着，你们现在不要发起新的选举，找个新领导来替代我”

在 Raft 算法中，随机超时时间是有 2 种含义的，这里是很多同学容易理解出错的地方，需要你注意一下：

		1. **跟随者等待领导者心跳信息超时的时间间隔，是随机的；**
  		2. **如果候选人在一个随机时间间隔内，没有赢得过半票数，那么选举无效了，然后候选人发起新一轮的选举，也就是说，等待选举超时的时间间隔，是随机的。**

明确这样几个重点。

​		Raft 算法和兰伯特的 Multi-Paxos 不同之处，主要有 2 点。

​		首先，在 Raft 中，不是所有节点都能当选领导者，只有日志较完整的节点（也就是日志完整度不比半数节点低的节点），才能当选领导者；其次，在 Raft 中，日志必须是连续的。

​		Raft 算法通过任期、领导者心跳消息、随机选举超时时间、先来先服务的投票原则、大多数选票原则等，保证了一个任期只有一位领导，也极大地减少了选举失败的情况。

​		本质上，Raft 算法以领导者为中心，选举出的领导者，以“一切以我为准”的方式，达成值的共识，和实现各节点日志的一致。



**Raft 算法本质**：通过一切以领导者为准的方式，实现一系列值的共识和各节点日志的一致
服务节点状态：
• 领导者（Leader）：处理写请求、管理日志复制、与跟随者间维持心跳服务
• 跟随者（Follower）：接受和处理来自领导者的消息，当领导者节点故障时，推荐自己进行选举
• 候选人（Candidate）：向其他跟随者节点发送请求投票 RPC 消息，通知投票，若获得大多数节点的投票，则成功竞选为领导者。
服务节点状态变更：
• 跟随者 -> 候选人 -> 领导者
• 领导者 -> 跟随者
• 候选人 -> 跟随者
Raft 算法通过任期、领导者心跳消息、随机选举超时时间、先来先服务的投票原则、大多数选票原则等，保证了一个任期只有一位领导，也极大地减少了选举失败的情况。具体的选举细节如下：
• 节点间通讯方式：RPC 通讯，分为请求投票 RPC 和日志复制 RPC。投票 RPC 由候选人发起，通知其他阶段进行投票选举； 日志复制 RPC 由领导者发起，用于日志复制和维持心跳服务。
• 领导者任期：与现实生活中领导者任期不同的是，这里的任期是指任期编号，而非任期时间。跟随者在等待领导者心跳信息超时后，推举自己为候选人时，会增加自己的任期号；如果一个服务器节点，发现自己的任期编号比其他节点小，那么它会更新自己的编号到较大的编号值。
• 在 Raft 算法中约定，如果一个候选人或者领导者，发现自己的任期编号比其他节点小，那么它会立即恢复成跟随者状态
• 如果一个节点接收到一个包含较小的任期编号值的请求，那么它会直接拒绝这个请求
• 选举规则：
• 领导者周期性地向所有跟随者发送心跳信息，维持自己的领导者状态
• 跟随者在随机超时时间内没有收到领导者的心跳信息，则发起领导者选举，节点状态变更为候选人，进入选举阶段
• 选举阶段，候选人收到超过半数以上的投票，节点状态变更为领导者，选举结束
• 选举阶段，一个服务节点最多会对一个任期编号投出一张选票，按照“先来先服务”原则进行投票；若任期编号同，则按照“日志完整性”原则进行投票。（日志完整性是服务节点的最后一条日志项对应的任期编号值和索引号。一般情况下，任期编号值更大，索引号更大）。
• 随机超时时间：
• 跟随者等待领导者心跳信息超时的时间间隔，是随机的
• 当没有候选人赢得过半票数，选举无效了，这时需要等待一个随机时间间隔，也就是说，等待选举超时的时间间隔，是随机的



在讨论分布式系统时，**共识算法（Consensus algorithm）和一致性（Consistency）通常是讨论热点**，两者的联系很微妙，很容易搞混。一些常见的误解：使用了 Raft [0] 或者 paxos 的系统都是线性一致的（Linearizability [1]，即强一致），其实不然，共识算法只能提供基础，要实现线性一致还需要在算法之上做出更多的努力。以 TiKV 为例，它的共识算法是 Raft，在 Raft 的保证下，TiKV 提供了满足线性一致性的服务。



## 线性一致性

什么是一致性，简单的来说就是评判一个并发系统正确与否的标准。线性一致性是其中一种，CAP [2] 中的 C 一般就指它。什么是线性一致性，或者说怎样才能达到线性一致？在回答这个问题之前先了解一些背景知识。

